<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Skill Bridge</title>
    <style>
        /* BASE STYLES */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #e5ddd5;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* HEADER - TSHWANE STYLE */
        .header {
            background: linear-gradient(90deg, #1a237e 0%, #0d47a1 100%);
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .header-info { margin-left: 15px; }
        .app-name { font-size: 18px; font-weight: bold; display: block; }
        .app-status { font-size: 12px; color: #ffc107; display: flex; align-items: center; }
        .status-dot { width: 8px; height: 8px; background-color: #00e676; border-radius: 50%; margin-right: 5px; box-shadow: 0 0 5px #00e676; }

        /* CHAT AREA */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 90px; /* More space for buttons */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* BUBBLES */
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 15px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }
        .message.ai { align-self: flex-start; background-color: white; color: #333; border-top-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .message.user { align-self: flex-end; background-color: #dcf8c6; color: #111; border-top-right-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* INPUT AREA */
        .input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #f0f0f0;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 8px; /* Tighter gap */
            border-top: 1px solid #ddd;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border-radius: 25px;
            border: 1px solid #ccc;
            outline: none;
            font-size: 16px;
        }

        /* BUTTONS */
        .btn {
            border: none;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
            font-size: 18px;
            color: white;
            flex-shrink: 0; /* Prevent squishing */
        }
        .btn:active { transform: scale(0.9); }
        
        .btn-mic { background-color: #ff3b30; } /* Red Mic */
        .btn-send { background-color: #00897b; } /* Teal Send */
        
        /* THE NEW SPEAKER TOGGLE */
        .btn-speaker { 
            background-color: #6c757d; /* Grey (Off) */
            font-size: 20px;
        }
        .btn-speaker.active {
            background-color: #0288d1; /* Blue (On) */
        }

        .listening { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <div style="font-size: 30px;">ðŸŒ‰</div>
        <div class="header-info">
            <span class="app-name">The Skill Bridge</span>
            <span class="app-status">
                <div class="status-dot"></div> Online | Tshwane
            </span>
        </div>
    </div>

    <!-- CHAT CONTAINER -->
    <div class="chat-container" id="chatBox">
        <div class="message ai">Heita! I am GenB. Re pusha life eng kajeno?</div>
    </div>

    <!-- INPUT AREA -->
    <div class="input-area">
        <!-- SPEAKER TOGGLE (STEALTH MODE) -->
        <button class="btn btn-speaker" id="voiceBtn" onclick="toggleVoice()">ðŸ”‡</button>

        <input type="text" id="userInput" placeholder="Type a message...">
        
        <button class="btn btn-mic" id="micBtn" onclick="startDictation()">ðŸŽ¤</button>
        <button class="btn btn-send" onclick="sendMessage()">âž¤</button>
    </div>

    <script>
        // --- STEALTH MODE LOGIC ---
        let voiceEnabled = false; // Start in Stealth Mode

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            let btn = document.getElementById('voiceBtn');
            
            if (voiceEnabled) {
                btn.innerText = "ðŸ”Š"; // Show Speaker
                btn.classList.add('active');
                // Optional: Announce it
                speakText("Voice Mode Activated");
            } else {
                btn.innerText = "ðŸ”‡"; // Show Mute
                btn.classList.remove('active');
                window.speechSynthesis.cancel(); // Stop talking immediately
            }
        }

        // --- SPEECH RECOGNITION ---
        function startDictation() {
            if (window.hasOwnProperty('webkitSpeechRecognition')) {
                var recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = "en-ZA"; 
                
                document.getElementById('micBtn').classList.add('listening');

                recognition.start();

                recognition.onresult = function(e) {
                    document.getElementById('userInput').value = e.results[0][0].transcript;
                    document.getElementById('micBtn').classList.remove('listening');
                    recognition.stop();
                    sendMessage();
                };
                recognition.onerror = function(e) { 
                    document.getElementById('micBtn').classList.remove('listening');
                    recognition.stop(); 
                }
            } else {
                alert("Voice not supported on this browser.");
            }
        }

        // --- SEND MESSAGE ---
        async function sendMessage() {
            let input = document.getElementById("userInput");
            let message = input.value;
            if (!message) return;

            addMessage(message, 'user');
            input.value = "";

            try {
                let apiResponse = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "message": message })
                });
                
                let data = await apiResponse.json();
                let aiText = data.response || data.error;
                
                addMessage(aiText, 'ai');
                
                // ONLY SPEAK IF TOGGLED ON
                if (voiceEnabled) {
                    speakText(aiText);
                }
                
            } catch (error) {
                addMessage("Eish, connection error!", 'ai');
            }
        }

        function addMessage(text, sender) {
            let box = document.getElementById("chatBox");
            let div = document.createElement("div");
            div.className = "message " + sender;
            div.innerHTML = text.replace(/\n/g, "<br>");
            box.appendChild(div);
            box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' });
        }

        // --- TEXT TO SPEECH ---
        function speakText(text) {
            let speech = new SpeechSynthesisUtterance();
            speech.text = text;
            speech.lang = "en-ZA";
            speech.rate = 1.0; 
            window.speechSynthesis.speak(speech);
        }
        
        document.getElementById("userInput").addEventListener("keypress", function(event) {
            if (event.key === "Enter") { sendMessage(); }
        });
    </script>

</body>
</html>
